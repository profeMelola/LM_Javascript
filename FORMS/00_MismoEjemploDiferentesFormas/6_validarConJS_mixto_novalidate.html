<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validar con JS MIXTO (novalidate)</title>
</head>

<body>
    <h1>Validación MIXTA - HTML5 + JS (novalidate)</h1>
    <h2>El campo "name" es obligatorio y su longitud mínima debe ser 5</h2>    
    <form name="myForm" action="../submit.html" method="post" novalidate>
        Name: <input type="text" name="fname" id="fname" required minlength="5">
        <input type="submit" value="Submit">
    </form>

    <script>
        //const fname = document.getElementById("fname");
        //const fname = document.querySelector("#fname");

        // El evento input se dispara cuando hay cambios en el value
        /*fname.addEventListener('input',e=>{

            // 2 formas de saber si las restricciones html5 son correctas
            console.log("e.target.validity.valid:");
            console.log(e.target.validity.valid);

            console.log("e.target.checkValidity():");
            console.log(e.target.checkValidity());

            // Vamos a personalizar el mensaje
            // if (!e.target.checkValidity()){
            //     console.log("¿Es demasiado corto?");
            //     console.log(e.target.validity.tooShort);
            //     if (e.target.validity.tooShort)
            //         e.target.setCustomValidity("Majete debe tener el campo una longitud min de 5 caracteres!!!!");
            //     else
            //     e.target.setCustomValidity("");
            // }
            checkError();
        });*/

        document.forms[0].addEventListener('submit',e=>{
            console.log("fname.checkValidity()");
            console.log(fname.validity.valid);

            if (fname.validity.valid)
                alert("correcto!!!!");
            else{
                //Al indicar que el form es novalidate, sí pasa por aquí y puedo controlarlo manualmente... 
                //alert("incorrecto!!!!");
                checkError();
                // Para que no haga el submit tengo que detener el evento con preventDefault!!!
                e.preventDefault();
            }
        });

        function checkError(){
            console.log("En checkError....");
            console.log(fname.checkValidity());
            if (!fname.checkValidity()){
                console.log(fname.validity.tooShort);
                if (fname.validity.tooShort){
                    fname.setCustomValidity("Pesaooo!!! escribe más!!!"); //Esto no sirve para nada porque está desactivado
                    
                    //voy a añadir el error como un elemento html (la primera vez)
                    if (document.querySelector('p') == null){
                        const body = document.querySelector('body');
                        const aviso = document.createElement('p');
                        aviso.innerHTML = "Pesaooo!!! escribe más!!!!!";
                        body.appendChild(aviso);
                    }
                }
                else{
                    //fname.setCustomValidity(); //esto no vale para nada si está el form novalidate
                    const aviso = document.querySelector('p');
                    aviso.innerHTML = "Sin error...";
                }
            }
        }

    </script>
</body>

</html>